<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chatbot de Política de Seguridad</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Base styles for the chat widget components */
        #root {
            font-family: sans-serif;
        }
        .chat-widget-container {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            transform-origin: bottom right;
        }
    </style>
    <script type="importmap">
    {
      "imports": {
        "react": "https://aistudiocdn.com/react@^19.2.0",
        "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
        "react/": "https://aistudiocdn.com/react@^19.2.0/",
        "@google/genai": "https://aistudiocdn.com/@google/genai@^1.22.0"
      }
    }
    </script>
</head>
<body>
    <div id="root"></div>
    <script type="module">
        import React, { useState, useRef, useEffect } from 'react';
        import ReactDOM from 'react-dom/client';
        import { GoogleGenAI } from "@google/genai";

        // --- All Application Code Bundled Below ---

        // --- Icon Components ---
        const ShieldCheckIcon = (props) => React.createElement("svg", { xmlns: "http://www.w3.org/2000/svg", width: "24", height: "24", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round", ...props },
          React.createElement("path", { d: "M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" }),
          React.createElement("path", { d: "m9 12 2 2 4-4" })
        );
        const BotIcon = (props) => React.createElement("svg", { xmlns: "http://www.w3.org/2000/svg", width: "24", height: "24", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round", ...props },
            React.createElement("rect", { x: "3", y: "11", width: "18", height: "10", rx: "2" }),
            React.createElement("circle", { cx: "12", cy: "5", r: "2" }),
            React.createElement("path", { d: "M12 7v4" }),
            React.createElement("line", { x1: "8", y1: "16", x2: "8", y2: "16" }),
            React.createElement("line", { x1: "16", y1: "16", x2: "16", y2: "16" })
        );
        const UserIcon = (props) => React.createElement("svg", { xmlns: "http://www.w3.org/2000/svg", width: "24", height: "24", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round", ...props },
            React.createElement("path", { d: "M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2" }),
            React.createElement("circle", { cx: "12", cy: "7", r: "4" })
        );
        const SendIcon = (props) => React.createElement("svg", { xmlns: "http://www.w3.org/2000/svg", width: "24", height: "24", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round", ...props },
            React.createElement("line", { x1: "22", y1: "2", x2: "11", y2: "13" }),
            React.createElement("polygon", { points: "22 2 15 22 11 13 2 9 22 2" })
        );
        const LinkIcon = (props) => React.createElement("svg", { xmlns: "http://www.w3.org/2000/svg", width: "24", height: "24", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round", ...props },
            React.createElement("path", { d: "M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.72" }),
            React.createElement("path", { d: "M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.72-1.72" })
        );
        const ChatBubbleIcon = (props) => React.createElement("svg", { xmlns: "http://www.w3.org/2000/svg", width: "24", height: "24", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round", ...props },
            React.createElement("path", { d: "M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" })
        );
        const XIcon = (props) => React.createElement("svg", { xmlns: "http://www.w3.org/2000/svg", width: "24", height: "24", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round", ...props },
            React.createElement("line", { x1: "18", y1: "6", x2: "6", y2: "18" }),
            React.createElement("line", { x1: "6", y1: "6", x2: "18", y2: "18" })
        );
        const RotateCwIcon = (props) => React.createElement("svg", { xmlns: "http://www.w3.org/2000/svg", width: "24", height: "24", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round", ...props },
            React.createElement("path", { d: "M21 2v6h-6" }),
            React.createElement("path", { d: "M3 12a9 9 0 0 1 15-6.7L21 8" }),
            React.createElement("path", { d: "M3 22v-6h6" }),
            React.createElement("path", { d: "M21 12a9 9 0 0 1-15 6.7L3 16" })
        );


        // --- Gemini Service ---
        const streamChatResponse = async function* (history) {
            if (!process.env.API_KEY) {
                yield { text: "Error: La clave API no está configurada. El chatbot no puede funcionar." };
                return;
            }
            const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });
            const SYSTEM_INSTRUCTION = `Eres un asistente de IA y tu única función es responder preguntas sobre el documento de la política de seguridad de TI de Tecnoglass, utilizando exclusivamente la información del sitio web 'https://ciberseguridad.tecnoglass.com'. No debes responder a ninguna otra pregunta o tema. Si un usuario te pregunta sobre algo que no sea la política de seguridad de TI de Tecnoglass o te pide información que no se encuentra en 'https://ciberseguridad.tecnoglass.com', debes negarte a responder amablemente. Tu respuesta en ese caso debe ser algo como: 'Lo siento, solo puedo proporcionar información sobre la política de seguridad de TI de Tecnoglass basada en el contenido de https://ciberseguridad.tecnoglass.com'. No interactúes sobre ningún otro tema. Cita siempre tus fuentes de 'https://ciberseguridad.tecnoglass.com'. Todas las respuestas deben estar en español. Formatea tus respuestas para que sean claras y fáciles de leer usando markdown.`;

            const historyForApi = history.slice(1);
            if (historyForApi.length === 0) return;

            const contents = historyForApi.map(msg => ({ role: msg.role, parts: [{ text: msg.content }] }));

            const responseStream = await ai.models.generateContentStream({
                model: 'gemini-2.5-flash',
                contents: contents,
                config: { systemInstruction: SYSTEM_INSTRUCTION, tools: [{ googleSearch: {} }] },
            });

            for await (const chunk of responseStream) {
                yield {
                    text: chunk.text,
                    groundingChunks: chunk.candidates?.[0]?.groundingMetadata?.groundingChunks
                };
            }
        };

        // --- Reusable Components ---
        const Header = ({ onClose, onClearChat }) => (
          React.createElement("header", { className: "bg-gray-800/50 backdrop-blur-sm p-4 border-b border-gray-700 flex items-center justify-between shadow-lg flex-shrink-0" },
            React.createElement("div", { className: "flex items-center" },
              React.createElement(ShieldCheckIcon, { className: "w-8 h-8 text-cyan-400 mr-3" }),
              React.createElement("div", null,
                React.createElement("h1", { className: "text-xl font-bold text-white" }, "Política de Seguridad"),
                React.createElement("p", { className: "text-sm text-gray-400" }, "Asistente IA")
              )
            ),
            React.createElement("div", { className: "flex items-center gap-2" },
                React.createElement("button", {
                    onClick: onClearChat,
                    className: "text-gray-400 hover:text-white transition-colors duration-200 p-2 rounded-full hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-cyan-500/50",
                    "aria-label": "Nueva conversación",
                    title: "Nueva conversación"
                },
                    React.createElement(RotateCwIcon, { className: "w-5 h-5" })
                ),
                React.createElement("button", { onClick: onClose, className: "text-gray-400 hover:text-white" },
                  React.createElement(XIcon, { className: "w-6 h-6" })
                )
            )
          )
        );

        const Message = ({ message }) => {
            const isModel = message.role === 'model';
            const formattedContent = message.content.replace(/(\*\*|__)(.*?)\1/g, '<strong>$2</strong>')
                .replace(/(`)(.*?)\1/g, '<code class="bg-gray-700 rounded px-1 py-0.5 text-sm font-mono">$2</code>')
                .replace(/\n/g, '<br />');

            return React.createElement("div", { className: `flex items-start gap-4 ${isModel ? 'justify-start' : 'justify-end'}` },
                isModel && React.createElement("div", { className: "w-8 h-8 rounded-full bg-gray-700 flex items-center justify-center flex-shrink-0 mt-1" },
                    React.createElement(BotIcon, { className: "w-5 h-5 text-cyan-400" })
                ),
                React.createElement("div", { className: `max-w-full px-4 py-3 rounded-xl shadow-md ${isModel ? 'bg-gray-800 text-gray-200 rounded-tl-none' : 'bg-blue-600 text-white rounded-br-none'}` },
                    message.content === '...' ?
                        React.createElement("div", { className: "flex items-center space-x-1" },
                            React.createElement("span", { className: "w-2 h-2 bg-gray-400 rounded-full animate-pulse [animation-delay:-0.3s]" }),
                            React.createElement("span", { className: "w-2 h-2 bg-gray-400 rounded-full animate-pulse [animation-delay:-0.15s]" }),
                            React.createElement("span", { className: "w-2 h-2 bg-gray-400 rounded-full animate-pulse" })
                        ) :
                        React.createElement("div", { className: "prose prose-invert prose-sm max-w-none break-words", dangerouslySetInnerHTML: { __html: formattedContent } }),
                    message.groundingChunks && message.groundingChunks.length > 0 &&
                        React.createElement("div", { className: "mt-4 pt-3 border-t border-gray-700/50" },
                            React.createElement("h4", { className: "text-xs font-semibold text-gray-400 mb-2" }, "Fuentes:"),
                            React.createElement("ul", { className: "space-y-1.5" },
                                message.groundingChunks.map((chunk, i) =>
                                    React.createElement("li", { key: i, className: "flex items-start gap-2" },
                                        React.createElement(LinkIcon, { className: "w-3 h-3 text-gray-500 mt-0.5 flex-shrink-0" }),
                                        React.createElement("a", { href: chunk.web.uri, target: "_blank", rel: "noopener noreferrer", className: "text-cyan-400 hover:underline text-xs break-all" },
                                            chunk.web.title || chunk.web.uri
                                        )
                                    )
                                )
                            )
                        )
                ),
                !isModel && React.createElement("div", { className: "w-8 h-8 rounded-full bg-gray-700 flex items-center justify-center flex-shrink-0 mt-1" },
                    React.createElement(UserIcon, { className: "w-5 h-5 text-gray-400" })
                )
            );
        };

        const ChatWindow = ({ messages, isLoading }) => {
            const chatEndRef = useRef(null);
            useEffect(() => {
                chatEndRef.current?.scrollIntoView({ behavior: 'smooth' });
            }, [messages]);

            return React.createElement("div", { className: "flex-1 overflow-y-auto p-6 space-y-6" },
                messages.map((msg, index) => React.createElement(Message, { key: index, message: msg })),
                isLoading && messages[messages.length - 1].role === 'user' && React.createElement(Message, { message: { role: 'model', content: '...' } }),
                React.createElement("div", { ref: chatEndRef })
            );
        };

        const ChatInput = ({ onSendMessage, isLoading }) => {
            const [input, setInput] = useState('');
            const handleSubmit = (e) => {
                e.preventDefault();
                if (input.trim() && !isLoading) {
                    onSendMessage(input);
                    setInput('');
                }
            };
            return React.createElement("form", { onSubmit: handleSubmit, className: "flex items-center gap-3" },
                React.createElement("input", {
                    type: "text", value: input, onChange: (e) => setInput(e.target.value),
                    placeholder: "Pregunta sobre la política...",
                    disabled: isLoading,
                    className: "flex-1 bg-gray-800 border border-gray-600 rounded-full py-2 px-5 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-cyan-500 transition duration-300 disabled:opacity-50",
                    autoComplete: "off"
                }),
                React.createElement("button", {
                    type: "submit", disabled: isLoading || !input.trim(),
                    className: "bg-blue-600 text-white rounded-full p-3 hover:bg-blue-500 disabled:bg-gray-600 disabled:cursor-not-allowed transition duration-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-gray-900"
                }, React.createElement(SendIcon, { className: "w-5 h-5" }))
            );
        };

        // --- Main App Logic ---
        const App = ({ onClose }) => {
            const INITIAL_MESSAGE = { role: 'model', content: "¡Hola! Soy un asistente de IA especializado. Solo puedo responder preguntas sobre la Política de Seguridad de TI de Tecnoglass, basándome en la información de https://ciberseguridad.tecnoglass.com." };
            const [messages, setMessages] = useState([INITIAL_MESSAGE]);
            const [isLoading, setIsLoading] = useState(false);

            const handleSendMessage = async (userInput) => {
                if (!userInput.trim()) return;
                const newMessages = [...messages, { role: 'user', content: userInput }];
                setMessages(newMessages);
                setIsLoading(true);
                setMessages((prev) => [...prev, { role: 'model', content: '' }]);

                try {
                    const stream = streamChatResponse(newMessages);
                    const allGroundingChunks = new Map();
                    for await (const part of stream) {
                        if (part.groundingChunks) {
                            part.groundingChunks.forEach(chunk => {
                                if (chunk.web?.uri) allGroundingChunks.set(chunk.web.uri, chunk.web);
                            });
                        }
                        setMessages((prev) => {
                            const last = prev[prev.length - 1];
                            if (last.role === 'model') {
                                const updated = [...prev];
                                updated[prev.length - 1] = { ...last, content: last.content + (part.text || ''), groundingChunks: Array.from(allGroundingChunks.values()).map(web => ({ web })) };
                                return updated;
                            }
                            return prev;
                        });
                    }
                } catch (err) {
                    const errorMsg = 'Lo siento, encontré un error. Por favor, inténtalo de nuevo.';
                    setMessages((prev) => {
                       const last = prev[prev.length - 1];
                       if (last.role === 'model' && last.content === '') {
                           const updated = [...prev];
                           updated[prev.length-1] = { ...last, content: errorMsg };
                           return updated;
                       }
                       return [...prev, {role: 'model', content: errorMsg}];
                    });
                } finally {
                    setIsLoading(false);
                }
            };

            const handleClearChat = () => {
                setMessages([INITIAL_MESSAGE]);
            };

            return React.createElement("div", { className: "bg-gray-900 text-white flex flex-col h-full w-full font-sans" },
                React.createElement(Header, { onClose: onClose, onClearChat: handleClearChat }),
                React.createElement("div", { className: "flex-grow overflow-hidden flex flex-col" },
                    React.createElement(ChatWindow, { messages: messages, isLoading: isLoading })
                ),
                React.createElement("div", { className: "flex-shrink-0 p-4 bg-gray-900 border-t border-gray-700" },
                    React.createElement(ChatInput, { onSendMessage: handleSendMessage, isLoading: isLoading }),
                    React.createElement("p", { className: "text-center text-xs text-gray-500 mt-3" },
                        "Las respuestas se basan en información pública."
                    )
                )
            );
        };
        
        // --- Floating Widget Container ---
        const FloatingChatWidget = () => {
            const [isOpen, setIsOpen] = useState(false);
            const toggleChat = () => setIsOpen(prev => !prev);
            
            const chatWindowStyle = {
                transform: isOpen ? 'scale(1)' : 'scale(0)',
                opacity: isOpen ? 1 : 0,
            };

            return React.createElement(React.Fragment, null,
                React.createElement("div", {
                    style: chatWindowStyle,
                    className: "chat-widget-container fixed bottom-24 right-5 sm:right-8 w-[calc(100%-40px)] sm:w-96 h-[70vh] max-h-[600px] rounded-2xl flex flex-col overflow-hidden z-[9999]"
                },
                    React.createElement(App, { onClose: toggleChat })
                ),
                React.createElement("button", {
                    onClick: toggleChat,
                    "aria-label": "Toggle Chat",
                    className: "fixed bottom-5 right-5 sm:right-8 w-16 h-16 bg-blue-600 rounded-full text-white flex items-center justify-center shadow-lg hover:bg-blue-500 transition-transform transform hover:scale-110 focus:outline-none focus:ring-4 focus:ring-blue-500/50 z-[9999]"
                },
                    isOpen ? React.createElement(XIcon, { className: "w-8 h-8" }) : React.createElement(ChatBubbleIcon, { className: "w-8 h-8" })
                )
            );
        };


        // --- Mount Application ---
        const rootElement = document.getElementById('root');
        const root = ReactDOM.createRoot(rootElement);
        root.render(React.createElement(FloatingChatWidget));
    </script>
</body>
</html>